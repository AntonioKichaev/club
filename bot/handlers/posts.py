import logging

import telegram
from django.urls import reverse
from telegram import Update
from telegram.ext import CallbackContext

from bot.handlers.common import get_club_user, get_club_post
from bot.decorators import is_club_member
from club import settings
from notifications.telegram.common import send_telegram_message, Chat
from posts.models.subscriptions import PostSubscription

log = logging.getLogger(__name__)


@is_club_member
def subscribe(update: Update, context: CallbackContext) -> None:
    user = get_club_user(update)
    if not user or not user.telegram_id:
        return None

    post = get_club_post(update)
    if not post:
        return None

    _, is_created = PostSubscription.subscribe(
        user=user,
        post=post,
        type=PostSubscription.TYPE_TOP_LEVEL_ONLY,
    )

    if user.telegram_id:
        post_url = settings.APP_HOST + reverse("show_post", kwargs={
            "post_type": post.type,
            "post_slug": post.slug,
        })

        send_telegram_message(
            chat=Chat(id=user.telegram_id),
            text=f"–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö "
                 f"–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –≤ –ø–æ—Å—Ç–µ ¬´<a href=\"{post_url}\">{post.title}</a>¬ª üîî\n\n"
                 f"–û–Ω–∏ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å—é–¥–∞ –≤ –±–æ—Ç–∞.",
            parse_mode=telegram.ParseMode.HTML,
        )


@is_club_member
def unsubscribe(update: Update, context: CallbackContext) -> None:
    user = get_club_user(update)
    if not user or not user.telegram_id:
        return None

    post = get_club_post(update)
    if not post:
        return None

    is_unsubscribed = PostSubscription.unsubscribe(
        user=user,
        post=post,
    )

    if user.telegram_id:
        post_url = settings.APP_HOST + reverse("show_post", kwargs={
            "post_type": post.type,
            "post_slug": post.slug,
        })

        if is_unsubscribed:
            send_telegram_message(
                chat=Chat(id=user.telegram_id),
                text=f"–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ –ø–æ—Å—Ç—É ¬´<a href=\"{post_url}\">{post.title}</a>¬ª üîï\n\n"
                     f"–û–¥–Ω–∞–∫–æ, –ª—é–¥–∏ –≤—Å—ë –µ—â–µ –º–æ–≥—É—Ç –ø–∏–Ω–≥–∞–Ω—É—Ç—å –≤–∞—Å –ø–æ –∏–º–µ–Ω–∏.",
                parse_mode=telegram.ParseMode.HTML,
            )
        else:
            send_telegram_message(
                chat=Chat(id=user.telegram_id),
                text=f"–í—ã –∏ —Ç–∞–∫ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø–æ—Å—Ç ¬´<a href=\"{post_url}\">{post.title}</a>¬ª. "
                     f"–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∫—Ç–æ-—Ç–æ —É–ø–æ–º—è–Ω—É–ª –≤–∞—Å –ø–æ –∏–º–µ–Ω–∏.",
                parse_mode=telegram.ParseMode.HTML,
            )
